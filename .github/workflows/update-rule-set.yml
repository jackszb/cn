name: "Update sing-box rule-set"

on:
  schedule:
    - cron: "0 0 * * *"  # 每天 UTC 0 点运行
  workflow_dispatch:

jobs:
  update-srs:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许 push

    steps:
      # 1️⃣ Checkout 仓库
      - name: Checkout repository
        uses: actions/checkout@v5

      # 2️⃣ 安装 sing-box
      - name: Setup sing-box
        env:
          SING_BOX_DEB_URL: "https://github.com/SagerNet/sing-box/releases/download/v1.12.12/sing-box_1.12.12_linux_amd64.deb"
        run: |
            wget -O sing-box.deb $SING_BOX_DEB_URL
            sudo dpkg -i sing-box.deb

      # 3️⃣ 设置 Python 虚拟环境并安装依赖
      - name: Setup Python
        run: |
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt

      # 4️⃣ 生成 .srs 文件到 work/
      - name: Generate .srs files
        run: |
            mkdir -p work
            source venv/bin/activate
            python3 generate_rule_set.py --output-dir work

      # 5️⃣ Commit & push 回仓库
      - name: Commit and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add work/
            git commit -m "Update .srs files" || echo "No changes to commit"
            git push origin HEAD
